global @once:
  labsconsole:
    - location: 'https://wikitech.wikimedia.org/wiki/Special:NovaServiceGroup'
    - project: cvn
    - add-service-group:
      - cvnservice (local-cvnservice; cvn.cvnservice)
  setup: |
      $ ssh cvn-{name}.eqiad.wmflabs
      $ umask 0002
      #
      ## Prepare directory structure on on NFS
      #
      $ cd /data/project
      $ sudo mkdir cvn-common
      $ sudo chgrp project-cvn cvn-common/
      $ sudo chmod 2775 cvn-common/
      $ mkdir cvn-common/backup/ cvn-common/log/ cvn-common/dropbox/

node @each:
  - packages:
    - git
    - nano
  - puppet:
    - see: https://wikitech.wikimedia.org/wiki/Hiera:Cvn
  # Remember:
  # - /data/project is an NFS mount shared between all servers.
  # - /srv is local to the individual server.
  - setup: |
      $ ssh cvn-X.cvn.eqiad.wmflabs
      #
      ## Create local directory structure
      #
      cd /srv
      sudo mkdir cvn
      sudo chgrp project-cvn cvn/
      sudo chmod 2775 cvn/
      mkdir cvn/git/ cvn/services/ cvn/log/
      sudo chgrp cvn.cvnservice cvn/services
      #
      ## Add repos
      #
      cd /srv/cvn/git
      git clone https://github.com/countervandalism/infrastructure.git
      git clone https://github.com/countervandalism/stillalive.git
      #
      ## Configure profile.d
      #
      cd /etc/profile.d/
      sudo ln -s /srv/cvn/git/infrastructure/environment-config/profile-d-umask-cvn.sh umask-cvn.sh
      #
      ## Configure stillalive
      #
      cd /srv/cvn/git/stillalive
      ln -s localSettings-cvn.yaml localSettings.yaml
      #
      ## File permissions
      #
      sudo chown root /srv/cvn/git/infrastructure/crontab-config/*.cron
      sudo chmod 644 /srv/cvn/git/infrastructure/crontab-config/*.cron
      #
      sudo chown root /srv/cvn/git/infrastructure/bin/backup-wmflabs-node
      sudo chown root /srv/cvn/git/infrastructure/bin/cvndb-CVNBot14-publish
      sudo chown root /srv/cvn/git/infrastructure/bin/cvndb-pull

node [type=webserver]:
  - services:
    - www

node [type=appserver]:
  - services:
    - CVNBot
    - stillalive
  - setup: |
      #
      # Back up data
      #
      cd /etc/cron.hourly/
      sudo ln -s /srv/cvn/git/infrastructure/bin/backup-wmflabs-node cvn-backup-data

node cvn-app6:
  - services:
    - CVNClerkBot

node cvn-app8:
  - setup: |
      cd /etc/cron.d/
      sudo ln -s /srv/cvn/git/infrastructure/crontab-config/cvndb-CVNBot14-publish.cron cvndb-CVNBot14-publish

service stillalive:
  - packages:
    - php7.0-cli
    - php7.0-mbstring # used by ulrichsg/getopt-php
  - setup: |
      cd /etc/cron.d/
      sudo ln -s /srv/cvn/git/infrastructure/crontab-config/stillalive.cron stillalive

service www:
  - packages:
    - libapache2-mod-php7.0
    - php-apcu
    - php-apcu-bc
    - php7.0-cli
    - php7.0-curl
    - php7.0-mysql
    - php7.0-sqlite3
  - setup: |
    #
    ## Add repos
    #
    $ cd /srv/cvn/git
    $ git clone https://github.com/countervandalism/cvn-api.git
    #
    ## Create document root
    #
    $ cd /srv/cvn/services
    $ ln -s /srv/cvn/git/infrastructure/cvn-docroot www
    $ cd www
    $ ln -s /srv/cvn/git/cvn-api/public_html/api.php api.php
    $ ln -s /data/project/cvn-common/log log
    #
    ## Setup cvn-api
    #
    $ cd /etc/cron.d/
    $ sudo ln -s /srv/cvn/git/infrastructure/crontab-config/cvndb-pull.cron cvndb-pull
    #
    ## Configure webserver
    #
    $ cd /etc/apache2/sites-available
    $ sudo ln -s /srv/cvn/git/infrastructure/apache-config/cvn.conf .
    $ cd /etc/apache2/sites-enabled
    $ sudo ln -s ../sites-available/cvn.conf 100-cvn
    $ sudo apachectl graceful

service CVNBot:
  - packages:
    - mono-complete
  - setup: |
    #
    ## Add repos
    #
    cd /srv/cvn/git
    git clone https://github.com/countervandalism/CVNBot.git
    cd /srv/cvn/services
    mkdir cvnbot
    #
    ## Import SSL certificates
    #
    # http://stackoverflow.com/a/11451213/319266
    # http://www.mono-project.com/docs/faq/security/
    #
    sudo -iu cvn.cvnservice mozroots --import --ask-remove
    sudo mozroots --import --ask-remove --machine

service CVNClerkBot:
  # https://github.com/countervandalism/CVNClerkBot
  # https://www.mediawiki.org/wiki/Manual:Pywikipedia
  # https://www.mediawiki.org/wiki/Manual:Pywikibot/Installation#compat_2
  - packages:
    - python@2.7.x
    - git-core
    - mysql-client
    - mysql-server
    - python-mysqldb
    - python-twisted-words
  - prepare:
    - database:
      - shell: |
        mysql -u root -proot -e 'CREATE DATABASE cvnclerkbot;'
  - backup:
    - database:
      - shell: |
        mysqldump cvnclerkbot -u root -proot --extended-insert=FALSE > ~/mysql_cvnclerkbot.sql
  - restore:
    - database:
      - shell: |
        mysql -u root -proot cvnclerkbot < /srv/cvn/git/infrastructure/mysql_cvnclerkbot.sql
  - setup: |
    #
    ## Add repos
    #
    $ cd /srv/cvn/git
    $ git clone https://github.com/countervandalism/CVNClerkBot.git
    $ git clone --recursive https://gerrit.wikimedia.org/r/pywikibot/compat.git pywikibot-compat
    #
    ## Configure pywikibot
    #
    $ cp /srv/cvn/git/infrastructure/cvnwiki_family.py /srv/cvn/git/pywikibot-compat/families/
    # Change from 644 to 664 - matching the default family files
    $ chmod 664 /srv/cvn/git/pywikibot-compat/families/cvnwiki_family.py
    $ cd  /srv/cvn/git/pywikibot-compat
    $ python ./generate_user_files.py
    # Interactive:
    # 1. Create user-config.py
    # 2. Select cvnwiki
    # 3. Username: Clogger
    # 4. Small file
    $ create pywikibot-compat/.passwd with `("Clogger", "<password>")`
    $ chmod 600 pywikibot-compat/.passwd
    $ edit pywikibot-compat/user-config.py and add `password_file = '.passwd'`
    #
    # FIXME: Fix this and stillalive/cvn-localSettings so that it can run as "cvn.cvnservice"
    $ sudo chown root pywikibot-compat/user-config.py
    $ sudo chown root pywikibot-compat/.passwd
    #
    ## Configure CVNClerkBot
    #
    $ cp /srv/cvn/git/infrastructure/clerkbotconfig.py CVNClerkBot/cvnclerkbotconfig.py
    $ edit CVNClerkBot/cvnclerkbotconfig.py
      - password
    $ edit CVNClerkBot/wikilog.py
      - samplewiki -> cvnwiki
    $ cd /srv/cvn/services
    $ mkdir CVNClerkBot
    $ edit CVNClerkBot/init.sh
      #!/usr/bin/env bash
      source /srv/cvn/git/infrastructure/bash-pythonpaths.sh && python /srv/cvn/git/CVNClerkBot/cvnclerkbot.py
    $ chmod +x CVNClerkBot/init.sh
    #
    $ exec prepare.database
    #
    # Run once manually to accept the deprecation warning of pywikibot-compat
    $ sudo CVNClerkBot/init.sh
    # Or, alternatively put the following:
    $ echo -e 'Compat deprecation warning shown\n' > /srv/cvn/git/pywikibot-compat/pywikibot/throttle.ctrl
