node @once:
  labsconsole:
    - location: 'https://wikitech.wikimedia.org/wiki/Special:NovaServiceGroup'
    - project: cvn
    - add-service-group:
      - cvnservice (local-cvnservice; cvn.cvnservice)
  setup: |
      $ ssh cvn-{name}.eqiad.wmflabs
      $ umask 0002
      #
      ## Set up project share on NFS
      #
      $ cd /data/project
      $ sudo mkdir cvn-common
      $ sudo chgrp project-cvn cvn-common/
      $ sudo chmod 2775 cvn-common/
      $ mkdir cvn-common/git/ cvn-common/backup/ cvn-common/log/ cvn-common/dropbox/
      #
      ## Add repos
      #
      $ cd /data/project/cvn-common/git
      $ git clone git@github.com:countervandalism/infrastructure.git
      $ git clone git@github.com:countervandalism/stillalive.git
      #
      ## File permissions
      #
      $ sudo chown root /data/project/cvn-common/git/infrastructure/crontab-config/*.cron
      $ sudo chmod 644 /data/project/cvn-common/git/infrastructure/crontab-config/*.cron
      #
      $ sudo chown root /data/project/cvn-common/git/infrastructure/bin/backup-wmflabs-node
      $ sudo chown root /data/project/cvn-common/git/infrastructure/bin/collect-wmflabs-log
      #
      ## Configure stillalive
      #
      $ cd /data/project/cvn-common/git/stillalive
      $ ln -s localSettings-cvn.json localSettings.json

node @each:
  - debian:
    - git-core
    - nano
  - puppet:
    - roles:
      - 'role::labs::lvm::srv'
  # Remember:
  # - /data/project/cvn is a shared mount between the servers.
  # - /srv/cvn is local to the instance.
  - setup: |
      #
      ## Forward key with -A in order to make authenticated git clones later
      #
      $ ssh -A cvn-{name}.eqiad.wmflabs
      #
      ## Create local directory structure
      #
      $ cd /srv
      $ sudo mkdir cvn
      $ sudo chgrp project-cvn cvn/
      $ sudo chmod 2775 cvn/
      $ mkdir cvn/git/ cvn/services/ cvn/log/
      $ sudo chgrp cvn.cvnservice cvn/services
      #
      ## Configure profile.d
      #
      $ cd /etc/profile.d/
      $ sudo ln -s /data/project/cvn-common/git/infrastructure/environment-config/profile-d-umask-cvn.sh umask-cvn.sh

node [type=webserver]:
  - services:
    - www

node [type=appserver]:
  - debian:
    - php5-cli
    - php5-sqlite
  - services:
    - CVNBot
    - stillalive
  - setup: |
      #
      # Back up data
      #
      $ cd /etc/cron.hourly/
      $ sudo ln -s /data/project/cvn-common/git/infrastructure/bin/backup-wmflabs-node cvn-backup-data
      #
      # Collect logs
      #
      $ cd /etc/cron.hourly/
      $ sudo ln -s /data/project/cvn-common/git/infrastructure/bin/collect-wmflabs-log cvn-collect-log

node cvn-app5:
  - services:
    - CVNClerkBot
  - setup: |
      $ cd /etc/cron.d/
      $ sudo ln -s /data/project/cvn-common/git/infrastructure/crontab-config/cvn-api-db-push-CVNBot14.cron cvn-api-db-push-CVNBot14

service stillalive:
  - setup: |
      $ cd /etc/cron.d/
      $ sudo ln -s /data/project/cvn-common/git/infrastructure/crontab-config/stillalive.cron stillalive

service www:
  - debian:
    - libapache2-mod-php5
    - php-apc
    - php-pear
    - php5-cli
    - php5-curl
    - php5-mysql
    - php5-sqlite
  - setup: |
    #
    ## Add repos
    #
    $ cd /srv/cvn/git
    $ git clone git@github.com:countervandalism/infrastructure.git
    $ git clone git@github.com:countervandalism/cvn-api.git
    #
    ## Create document root
    #
    $ cd /srv/cvn/services
    $ ln -s /srv/cvn/git/infrastructure/cvn-docroot www
    $ cd www
    $ ln -s /srv/cvn/git/cvn-api/public_html/api.php api.php
    $ ln -s /data/project/cvn-common/log log
    #
    ## Setup cvn-api
    #
    $ cd /etc/cron.d/
    $ sudo ln -s /data/project/cvn-common/git/infrastructure/crontab-config/cvn-api-db-pull.cron cvn-api-db-pull
    #
    ## Configure webserver
    #
    $ cd /etc/apache2/sites-available
    $ sudo ln -s /srv/cvn/git/infrastructure/apache-config/cvn.conf .
    $ cd /etc/apache2/sites-enabled
    $ sudo ln -s ../sites-available/cvn.conf 100-cvn
    $ sudo apachectl graceful

service CVNBot:
  - debian:
    - mono-complete
  - setup: |
    #
    ## Add repos
    #
    $ cd /srv/cvn/git
    $ git clone git@github.com:countervandalism/infrastructure.git # Needed for Console.msgs links
    $ git clone git@github.com:countervandalism/CVNBot.git
    $ cd /srv/cvn/services
    $ mkdir cvnbot

service CVNClerkBot:
  # https://github.com/countervandalism/CVNClerkBot
  # https://www.mediawiki.org/wiki/Manual:Pywikipediabot
  # https://github.com/Krinkle/ts-krinkle-pywiki
  - debian:
    - python@2.7.3
    - subversion # pywikibot
    - mysql-client
    - mysql-server
    - python-mysqldb
    - python-twisted-words
  - prepare:
    - database:
      - shell: |
        mysql -u root -proot -e 'CREATE DATABASE cvnclerkbot;'
  - backup:
    - database:
      - shell: |
        mysqldump cvnclerkbot -u root -proot --extended-insert=FALSE > mysql_cvnclerkbot.sql
  - restore:
    - database:
      - shell: |
        mysql -u root -proot cvnclerkbot < mysql_cvnclerkbot.sql
  - setup: |
    $ cd /srv/cvn/git
    $ git clone https://github.com/countervandalism/CVNClerkBot.git
    $ cp /data/project/cvn-common/git/infrastructure/clerkbox-config.py CVNClerkBot/cvnclerkbotconfig.py
    $ edit CVNClerkBot/wikilog.py
      - samplewiki -> cvnwiki
      - logname -> Developer Log
    $ cd /srv/cvn/services
    $ mkdir CVNClerkBot
    $ edit CVNClerkBot/init.sh
      #!/usr/bin/env bash
      source /data/project/cvn-common/git/infrastructure/bash-pythonpaths.sh && python /srv/cvn/git/CVNClerkBot/cvnclerkbot.py
    $ chmod +x CVNClerkBot/init.sh
