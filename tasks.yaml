# Tasks related to stillalive
# https://github.com/countervandalism/stillalive
tasks stillalive:
  - quit-a-bot:
    - try:
      - 'irc #cvn-bots'
      - say 'MyBotName quit'
    - else:
      # Connect to the server where the bot used to be pooled
      - ssh cvn-appX.cvn.eqiad.wmflabs
      - 'ps aux | grep MyBotName'
      # Find the process id, and terminate it
      - sudo kill 123

  - deploy-a-change:
    # After you've made a change to the settings file in the repository on GitHub, we need
    # to deploy it on our cluster in wmflabs:
    - ssh cvn-appX.cvn.eqiad.wmflabs
    - cd /srv/cvn/git/stillalive
    - git pull origin master

  # Set up a new bot
  - add:
    - do 'Follow install and setup instructions for the new bot and have it working on the new server'
    - do 'Add a new task for MyBotName' to 'localSettings-cvn.yaml' in github:countervandalism/stillalive.git
        # Either with a text editor on your local computer and push with Git,
        # or, use the online editor:
        # https://github.com/countervandalism/stillalive/edit/master/localSettings-cvn.yaml
    - deploy-a-change
    - force-run

  # Change on which node a process is pooled
  - move:
    - do 'Change the pool property from server PREV to NEXT for MyBotName' in 'localSettings-cvn.yaml' in github:countervandalism/stillalive.git
    # Deploy the stillalive change to the previous server first (so that it won't restart there),
    # then kill the active bot from IRC. Then copy the bot (while not running) to the new server.
    - deploy-a-change@cvn-appX(PREVIOUS)
    - quit-a-bot
    - ssh cvn-appX(PREV).eqiad.wmflabs
      - rsync -v -c -a --delete-delay --compress /srv/cvn/services/cvnbot/MyBotName /data/project/cvn-common/dropbox/
    - ssh cvn-appX(NEXT).eqiad.wmflabs
      - rsync -v -c -a --delete-delay --compress /data/project/cvn-common/dropbox/MyBotName /srv/cvn/services/cvnbot/
    - deploy-a-change@cvn-appX(NEXT)
    - force-run@cvn-appX(NEXT)

  - remove:
    - deploy-a-change
    # stillalive only starts processes, it doesn't quit them because
    # after you remove the setting, it no longer knows about it.
    # Manually terminate the old bot process.
    - quit-a-bot

  - force-run
    - ssh cvn-appX.cvn.eqiad.wmflabs
    - `sudo /srv/cvn/git/stillalive/bin/stillalive --pool=$(hostname)`

tasks CVNBot:
  # https://github.com/countervandalism/CVNBot
  - install:
    - 'https://github.com/countervandalism/CVNBot#build'
    - 'https://github.com/countervandalism/CVNBot/wiki/Documentation#installation'

  - setup@cvn.wmflabs:
    - install:
      - ssh cvn-appX.eqiad.wmflabs
      - cd /srv/cvn/git/CVNBot
      - 'git remote update && git checkout origin/master'
      - cd src/CVNBot
      - xbuild CVNBot.csproj /p:Configuration=Release
      - mv bin/Release /srv/cvn/services/cvnbot/MyBotName
      - cp ../CVNBot-sample.ini /srv/cvn/services/cvnbot/MyBotName/CVNBot.ini
      - cd /srv/cvn/services/cvnbot/MyBotName
      - nano CVNBot.ini
        # 'botnick' and 'botpass'. See https://meta.wikimedia.org/wiki/Countervandalism_Network/Management#Bots.
        #    e.g. botnick=CVNBot5 and botpass=(CVN-Bots2 password)
        # 'partmsg': "https://meta.wikimedia.org/wiki/CVN"
        # 'controlchannel': "#cvn-bots"
        # 'feedchannel': "#cvn-..."
        # 'broadcastchannel': "#cvn-broadcast"
        # 'restartarg': Full in the full path to CVNBot.exe (e.g. "mono /srv/cvn/services/cvnbot/MyBotName/CVNBot.exe")
      - if "You're migrating data from an old bot":
      - edit CVNBot.ini
        - cp ../oldbot/CVNBot.ini .
        - cp ../oldbot/Lists.sqlite .
        - cp ../oldbot/Projects.xml .
      - chgrp cvn.cvnservice -R /srv/cvn/services/cvnbot/MyBotName
      - chmod 664 *
      - chmod 775 CVNBot.exe Lists.sqlite
      - chmod 660 CVNBot.ini
    - upgrade:
      - ssh cvn-appX.eqiad.wmflabs
      - cd /srv/cvn/git/CVNBot
      - 'git remote update && git checkout origin/master'
      - cd src/CVNBot
      - xbuild CVNBot.csproj /p:Configuration=Release
      # Take take to ONLY copy CVNBot.exe.
      # New builds will come with an empty state files (CVNBot.ini, Lists.sqlite, Projects.xml)
      # But those must NOT be copied cover as else you'll destroy the existing bot
      - stillalive.quit-a-bot
      - mv bin/Release/CVNBot.exe /srv/cvn/services/cvnbot/MyBotName
      - stillalive.force-run
      - CVNBot.monitor
    - monitor:
      - ssh cvn-appX.eqiad.wmflabs
      - sudo tail -n100 -f /var/log/syslog | grep CVNBot
    - test:
      # Run test on a cvn-app server because cvn-dev is subject to general
      # IP connection limit of all of wmflabs (cvn-app servers have a dedicated IP)
      - ssh cvn-appX.eqiad.wmflabs
      - cd /srv/cvn/services/cvnbot/MyBotName
      - mono CVNBot.exe
      - assert "Bot MyBotName has joined #cvn-... channel and works as expected"
      - do "Any additional setup if you need to (e.g. load or drop more wikis in memory)"
      - do "kill the process from the command line (it was started from your shell so Ctrl^C will do)"
    - schedule:
      - stillalive add MyBotName
    - done!
      # The next time stillalive runs its job queue from crontab on the various cvn-app hosts,
      # the bot will be started.
